<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>é“¶è¡Œè®¾å¤‡ç›‘æ§ä»ªè¡¨æ¿</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 30px;
            background: #f0f2f5;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #1890ff;
            margin-bottom: 10px;
        }
        .header p {
            color: #666;
        }
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .chart-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            border-left: 4px solid #1890ff;
            padding-left: 10px;
        }
        .chart {
            width: 100%;
            height: 400px;
        }
        .stats-row {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .stat-box {
            background: white;
            border-radius: 10px;
            padding: 20px;
            width: 22%;
            min-width: 200px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin: 10px;
        }
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #1890ff;
            margin: 10px 0;
        }
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            background: #fafafa;
            font-weight: 600;
        }
        tr:hover {
            background: #f5f5f5;
        }
        @media (max-width: 768px) {
            .chart {
                height: 300px;
            }
            .stat-box {
                width: 100%;
            }
        }
    </style>
</head>
<body>
<div class="header">
    <h1>ğŸ¦ é“¶è¡Œè®¾å¤‡ç›‘æ§ä»ªè¡¨æ¿</h1>
    <p>å®æ—¶ç›‘æ§å„æ”¯è¡Œè®¾å¤‡çŠ¶æ€ï¼Œä¿éšœé‡‘èæœåŠ¡è¿ç»­æ€§</p >
</div>

<!-- å…³é”®æŒ‡æ ‡ -->
<div class="stats-row">
    <div class="stat-box">
        <div class="stat-label">æ•´ä½“åœ¨çº¿ç‡</div>
        <div class="stat-number" id="overallRate">--%</div>
    </div>
    <div class="stat-box">
        <div class="stat-label">æ€»è®¾å¤‡æ•°</div>
        <div class="stat-number" id="totalDevices">--</div>
    </div>
    <div class="stat-box">
        <div class="stat-label">ä¿ä¿®é¢„è­¦</div>
        <div class="stat-number" id="warrantyAlerts">--</div>
    </div>
    <div class="stat-box">
        <div class="stat-label">æ•…éšœè®¾å¤‡</div>
        <div class="stat-number" id="faultDevices">--</div>
    </div>
</div>

<!-- æ”¯è¡Œå¥åº·åº¦å›¾è¡¨ -->
<div class="chart-container">
    <div class="chart-title">å„æ”¯è¡Œè®¾å¤‡åœ¨çº¿ç‡</div>
    <div id="healthChart" class="chart"></div>
</div>

<!-- ä¿ä¿®é¢„è­¦è¡¨æ ¼ -->
<div class="chart-container">
    <div class="chart-title">ä¿ä¿®åˆ°æœŸé¢„è­¦ï¼ˆæœªæ¥30å¤©ï¼‰</div>
    <table id="warrantyTable">
        <thead>
        <tr>
            <th>è®¾å¤‡åç§°</th>
            <th>æ‰€å±æ”¯è¡Œ</th>
            <th>åˆ°æœŸæ—¥æœŸ</th>
            <th>å‰©ä½™å¤©æ•°</th>
        </tr>
        </thead>
        <tbody id="warrantyTableBody">
        <!-- æ•°æ®ç”±JSå¡«å…… -->
        <tr><td colspan="4" style="text-align:center;padding:20px;">åŠ è½½ä¸­...</td></tr>
        </tbody>
    </table>
</div>

<!-- æ•…éšœåˆ†æå›¾è¡¨ -->
<div class="chart-container">
    <div class="chart-title">æ•…éšœç±»å‹ä¸å¹³å‡ä¿®å¤æ—¶é—´</div>
    <div id="faultChart" class="chart"></div>
</div>

<!-- åº•éƒ¨ä¿¡æ¯ -->
<div style="text-align:center;color:#999;margin-top:30px;font-size:14px;">
    æ•°æ®æ›´æ–°æ—¶é—´: <span id="updateTime">--</span>
</div>

<script>
    // åˆå§‹åŒ–å›¾è¡¨
    const healthChart = echarts.init(document.getElementById('healthChart'));
    const faultChart = echarts.init(document.getElementById('faultChart'));

    // åŠ è½½æ‰€æœ‰æ•°æ®
    async function loadData() {
        try {
            // å¹¶è¡ŒåŠ è½½3ä¸ªæ¥å£çš„æ•°æ®
            const [healthData, warrantyData, faultData, devicesData] = await Promise.all([
                fetch('/api/devices/stats/branch-health').then(r => r.json()),
                fetch('/api/devices/stats/warranty-alert').then(r => r.json()),
                fetch('/api/devices/stats/fault-analysis').then(r => r.json()),
                fetch('/api/devices').then(r => r.json())
            ]);

            // æ›´æ–°æŒ‡æ ‡å¡ç‰‡
            updateMetrics(healthData, warrantyData, faultData, devicesData);

            // æ¸²æŸ“å›¾è¡¨
            renderHealthChart(healthData);
            renderFaultChart(faultData);

            // å¡«å……é¢„è­¦è¡¨æ ¼
            renderWarrantyTable(warrantyData);

            // æ›´æ–°æ—¶é—´
            document.getElementById('updateTime').textContent = new Date().toLocaleString('zh-CN');

        } catch (error) {
            console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
            alert('æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ');
        }
    }

    // æ›´æ–°æŒ‡æ ‡å¡ç‰‡
    function updateMetrics(healthData, warrantyData, faultData, devicesData) {
        // æ•´ä½“åœ¨çº¿ç‡
        document.getElementById('overallRate').textContent = healthData.overallOnlineRate || '--%';

        // æ€»è®¾å¤‡æ•°
        document.getElementById('totalDevices').textContent = devicesData.data?.length || '--';

        // ä¿ä¿®é¢„è­¦æ•°é‡
        document.getElementById('warrantyAlerts').textContent = warrantyData.length || '0';

        // æ•…éšœè®¾å¤‡æ•°ï¼ˆä»å¥åº·åº¦æ•°æ®è®¡ç®—ï¼‰
        let faultCount = 0;
        if (healthData.branchStats) {
            healthData.branchStats.forEach(branch => {
                faultCount += branch.fault_count || 0;
            });
        }
        document.getElementById('faultDevices').textContent = faultCount;
    }

    // æ¸²æŸ“æ”¯è¡Œå¥åº·åº¦å›¾è¡¨
    function renderHealthChart(data) {
        if (!data.branchStats) return;

        const branches = data.branchStats.map(item => item.branch);
        const rates = data.branchStats.map(item => item.online_rate);
        const onlineCounts = data.branchStats.map(item => `${item.online}/${item.total}`);

        const option = {
            tooltip: {
                trigger: 'axis',
                formatter: function(params) {
                    const data = params[0];
                    return `${data.name}<br/>åœ¨çº¿ç‡: ${data.value}%<br/>åœ¨çº¿è®¾å¤‡: ${onlineCounts[data.dataIndex]}`;
                }
            },
            xAxis: {
                type: 'category',
                data: branches,
                axisLabel: { rotate: 30 }
            },
            yAxis: {
                type: 'value',
                name: 'åœ¨çº¿ç‡(%)',
                max: 100
            },
            series: [{
                data: rates,
                type: 'bar',
                itemStyle: {
                    color: function(params) {
                        return params.value >= 90 ? '#52c41a' :
                            params.value >= 70 ? '#1890ff' :
                                params.value >= 50 ? '#faad14' : '#ff4d4f';
                    }
                },
                label: {
                    show: true,
                    position: 'top',
                    formatter: '{c}%'
                }
            }]
        };

        healthChart.setOption(option);
    }

    // æ¸²æŸ“æ•…éšœåˆ†æå›¾è¡¨
    function renderFaultChart(data) {
        if (!data.faultAnalysis || data.faultAnalysis.length === 0) {
            faultChart.setOption({
                title: {
                    text: 'æš‚æ— æ•…éšœè®°å½•',
                    left: 'center',
                    top: 'center',
                    textStyle: { color: '#999', fontSize: 16 }
                }
            });
            return;
        }

        const faultTypes = data.faultAnalysis.map(item => item.faultCode);
        const fixTimes = data.faultAnalysis.map(item => item.avgFixTimeMinutes);

        const option = {
            tooltip: {
                trigger: 'axis',
                formatter: function(params) {
                    const minutes = params[0].value;
                    const hours = (minutes / 60).toFixed(1);
                    return `${params[0].name}<br/>å¹³å‡ä¿®å¤æ—¶é—´: ${minutes}åˆ†é’Ÿ (${hours}å°æ—¶)`;
                }
            },
            xAxis: {
                type: 'category',
                data: faultTypes
            },
            yAxis: {
                type: 'value',
                name: 'ä¿®å¤æ—¶é—´(åˆ†é’Ÿ)'
            },
            series: [{
                data: fixTimes,
                type: 'bar',
                itemStyle: {
                    color: '#ff4d4f'
                },
                label: {
                    show: true,
                    position: 'top',
                    formatter: function(params) {
                        const hours = (params.value / 60).toFixed(1);
                        return hours + 'h';
                    }
                }
            }]
        };

        faultChart.setOption(option);
    }

    // æ¸²æŸ“ä¿ä¿®é¢„è­¦è¡¨æ ¼
    function renderWarrantyTable(data) {
        const tbody = document.getElementById('warrantyTableBody');

        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:20px;color:#999;">æš‚æ— ä¿ä¿®åˆ°æœŸè®¾å¤‡</td></tr>';
            return;
        }

        let html = '';
        data.forEach(device => {
            const daysLeft = device.daysRemaining;
            let warning = '';
            if (daysLeft <= 7) warning = 'âš ï¸ ';

            html += `
                <tr>
                    <td>${warning}${device.deviceName || device.deviceId}</td>
                    <td>${device.branch || '--'}</td>
                    <td>${device.warrantyEndDate ? device.warrantyEndDate.split('T')[0] : '--'}</td>
                    <td style="color:${daysLeft <= 7 ? '#ff4d4f' : daysLeft <= 30 ? '#faad14' : '#52c41a'}">
                        ${daysLeft}å¤©
                    </td>
                </tr>`;
        });

        tbody.innerHTML = html;
    }

    // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', loadData);

    // æ¯60ç§’è‡ªåŠ¨åˆ·æ–°
    setInterval(loadData, 60000);
</script>
</body>
</html>